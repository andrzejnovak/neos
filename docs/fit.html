---

title: fullstream.fit

keywords: fastai
sidebar: home_sidebar

summary: "Module that wraps constrained + global fitters in a differentiable form using the module fax. Uses the two-phase-solver."
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 05_fit.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
    {% raw %}
        
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_solvers" class="doc_header"><code>get_solvers</code><a href="https://github.com/phinate/fullstream/tree/master/fullstream/fit.py#L12" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_solvers</code>(<strong><code>model_constructor</code></strong>, <strong><code>pdf_transform</code></strong>=<em><code>False</code></em>, <strong><code>default_rtol</code></strong>=<em><code>1e-10</code></em>, <strong><code>default_atol</code></strong>=<em><code>1e-10</code></em>, <strong><code>default_max_iter</code></strong>=<em><code>1000000</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="getting-test">getting test<a class="anchor-link" href="#getting-test">&#182;</a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fullstream.models</span> <span class="kn">import</span> <span class="n">nn_model_maker</span>

<span class="n">g_fitter</span><span class="p">,</span> <span class="n">c_fitter</span> <span class="o">=</span> <span class="n">get_solvers</span><span class="p">(</span><span class="n">nn_model_maker</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="non-transformed-fit-test">non-transformed fit test<a class="anchor-link" href="#non-transformed-fit-test">&#182;</a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fullstream.nn</span> <span class="kn">import</span> <span class="n">three_blob_classifier</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">three_blob_classifier</span><span class="p">()</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">num_epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">nn_params</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">params</span>

<span class="n">g_fitter</span><span class="p">,</span> <span class="n">c_fitter</span> <span class="o">=</span> <span class="n">get_solvers</span><span class="p">(</span><span class="n">nn_model_maker</span><span class="p">,</span> <span class="n">pdf_transform</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">m</span><span class="p">,</span> <span class="n">bonlypars</span> <span class="o">=</span> <span class="n">nn_model_maker</span><span class="p">(</span><span class="n">nn_params</span><span class="p">)</span>
<span class="n">exp_data</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">expected_data</span><span class="p">(</span><span class="n">bonlypars</span><span class="p">)</span>
<span class="n">bounds</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">suggested_bounds</span><span class="p">()</span>

<span class="n">test_mu</span> <span class="o">=</span> <span class="mf">1.0</span>

<span class="c1"># map these</span>
<span class="n">initval</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">test_mu</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
<span class="c1"># the constrained fit</span>
<span class="n">numerator</span> <span class="o">=</span> <span class="n">c_fitter</span><span class="p">(</span><span class="n">initval</span><span class="p">,</span> <span class="p">[</span><span class="n">test_mu</span><span class="p">,</span> <span class="n">nn_params</span><span class="p">])</span>
<span class="c1"># the global fit</span>
<span class="n">denominator</span> <span class="o">=</span> <span class="n">g_fitter</span><span class="p">(</span><span class="n">initval</span><span class="p">,</span> <span class="p">[</span><span class="n">test_mu</span><span class="p">,</span> <span class="n">nn_params</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;constrained fit: </span><span class="si">{numerator}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;global fit: </span><span class="si">{denominator}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1">#print(f&quot;transformed constrained fit: {transform_lim_vec(numerator,bounds)}&quot;)</span>
<span class="c1">#print(f&quot;transformed global fit: {transform_lim_vec(denominator,bounds)}&quot;)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/home/phinate/envs/fullstream/lib/python3.7/site-packages/jax-0.1.58-py3.7.egg/jax/lib/xla_bridge.py:119: UserWarning: No GPU/TPU found, falling back to CPU.
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>
Starting training...
Epoch 0 in 4.80 sec
Training set accuracy 0.8476
model: [ 6.40477037 13.59522963],[43.13707402  6.86292598],[4.44113382 4.44113382]
model: Traced&lt;ShapedArray(float64[2]):JaxprTrace(level=0/0)&gt;,Traced&lt;ShapedArray(float64[2]):JaxprTrace(level=0/0)&gt;,Traced&lt;ShapedArray(float64[2]):JaxprTrace(level=0/0)&gt;
model: Traced&lt;ShapedArray(float64[2]):JaxprTrace(level=0/0)&gt;,Traced&lt;ShapedArray(float64[2]):JaxprTrace(level=0/0)&gt;,Traced&lt;ShapedArray(float64[2]):JaxprTrace(level=0/0)&gt;
constrained fit: [1.         0.96071416]
global fit: [0.01694888 1.0021199 ]
</pre>
</div>
</div>

<div class="output_area">



<div class="output_png output_subarea ">
<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAV0AAADnCAYAAAC9roUQAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAALEgAACxIB0t1+/AAAADt0RVh0U29mdHdhcmUAbWF0cGxvdGxpYiB2ZXJzaW9uMy4yLjByYzMsIGh0dHA6Ly9tYXRwbG90bGliLm9yZy9h23ruAAADKUlEQVR4nO3UMQEAIAzAMMC/5+GiHCQKenXPzAKgcV4HAPzEdAFCpgsQMl2AkOkChEwXIGS6ACHTBQiZLkDIdAFCpgsQMl2AkOkChEwXIGS6ACHTBQiZLkDIdAFCpgsQMl2AkOkChEwXIGS6ACHTBQiZLkDIdAFCpgsQMl2AkOkChEwXIGS6ACHTBQiZLkDIdAFCpgsQMl2AkOkChEwXIGS6ACHTBQiZLkDIdAFCpgsQMl2AkOkChEwXIGS6ACHTBQiZLkDIdAFCpgsQMl2AkOkChEwXIGS6ACHTBQiZLkDIdAFCpgsQMl2AkOkChEwXIGS6ACHTBQiZLkDIdAFCpgsQMl2AkOkChEwXIGS6ACHTBQiZLkDIdAFCpgsQMl2AkOkChEwXIGS6ACHTBQiZLkDIdAFCpgsQMl2AkOkChEwXIGS6ACHTBQiZLkDIdAFCpgsQMl2AkOkChEwXIGS6ACHTBQiZLkDIdAFCpgsQMl2AkOkChEwXIGS6ACHTBQiZLkDIdAFCpgsQMl2AkOkChEwXIGS6ACHTBQiZLkDIdAFCpgsQMl2AkOkChEwXIGS6ACHTBQiZLkDIdAFCpgsQMl2AkOkChEwXIGS6ACHTBQiZLkDIdAFCpgsQMl2AkOkChEwXIGS6ACHTBQiZLkDIdAFCpgsQMl2AkOkChEwXIGS6ACHTBQiZLkDIdAFCpgsQMl2AkOkChEwXIGS6ACHTBQiZLkDIdAFCpgsQMl2AkOkChEwXIGS6ACHTBQiZLkDIdAFCpgsQMl2AkOkChEwXIGS6ACHTBQiZLkDIdAFCpgsQMl2AkOkChEwXIGS6ACHTBQiZLkDIdAFCpgsQMl2AkOkChEwXIGS6ACHTBQiZLkDIdAFCpgsQMl2AkOkChEwXIGS6ACHTBQiZLkDIdAFCpgsQMl2AkOkChEwXIGS6ACHTBQiZLkDIdAFCpgsQMl2AkOkChEwXIGS6ACHTBQiZLkDIdAFCpgsQMl2AkOkChEwXIGS6ACHTBQiZLkDIdAFCpgsQMl2AkOkChEwXIGS6ACHTBQiZLkDIdAFCpgsQMl2AkOkChEwXIHQBcjcEy3+fc28AAAAASUVORK5CYII=
"
>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="transformed-fit-test">transformed fit test<a class="anchor-link" href="#transformed-fit-test">&#182;</a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">g_fitter</span><span class="p">,</span> <span class="n">c_fitter</span> <span class="o">=</span> <span class="n">get_solvers</span><span class="p">(</span><span class="n">nn_model_maker</span><span class="p">,</span> <span class="n">pdf_transform</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">m</span><span class="p">,</span> <span class="n">bonlypars</span> <span class="o">=</span> <span class="n">nn_model_maker</span><span class="p">(</span><span class="n">nn_params</span><span class="p">)</span>
<span class="n">exp_data</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">expected_data</span><span class="p">(</span><span class="n">bonlypars</span><span class="p">)</span>
<span class="n">bounds</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">suggested_bounds</span><span class="p">()</span>

<span class="n">test_mu</span> <span class="o">=</span> <span class="mf">1.0</span>

<span class="n">initval</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">test_mu</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>

<span class="c1"># transform everything to inf space</span>
<span class="n">initval</span> <span class="o">=</span> <span class="n">inv_transform_lim_vec</span><span class="p">(</span><span class="n">initval</span><span class="p">,</span> <span class="n">bounds</span><span class="p">)</span>
<span class="n">init_test_mu</span> <span class="o">=</span> <span class="n">inv_transform_lim</span><span class="p">(</span><span class="n">test_mu</span><span class="p">,</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="c1"># do fits, then transform answers to bounded space</span>
<span class="n">numerator</span> <span class="o">=</span> <span class="n">transform_lim_vec</span><span class="p">(</span><span class="n">c_fitter</span><span class="p">(</span><span class="n">initval</span><span class="p">,</span> <span class="p">[</span><span class="n">init_test_mu</span><span class="p">,</span> <span class="n">nn_params</span><span class="p">]),</span> <span class="n">bounds</span><span class="p">)</span>
<span class="n">denominator</span> <span class="o">=</span> <span class="n">transform_lim_vec</span><span class="p">(</span><span class="n">g_fitter</span><span class="p">(</span><span class="n">initval</span><span class="p">,</span> <span class="p">[</span><span class="n">init_test_mu</span><span class="p">,</span> <span class="n">nn_params</span><span class="p">]),</span> <span class="n">bounds</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;constrained fit: </span><span class="si">{numerator}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;global fit: </span><span class="si">{denominator}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>model: [ 6.40477037 13.59522963],[43.13707402  6.86292598],[4.44113382 4.44113382]
model: Traced&lt;ShapedArray(float64[2]):JaxprTrace(level=0/0)&gt;,Traced&lt;ShapedArray(float64[2]):JaxprTrace(level=0/0)&gt;,Traced&lt;ShapedArray(float64[2]):JaxprTrace(level=0/0)&gt;
model: Traced&lt;ShapedArray(float64[2]):JaxprTrace(level=0/0)&gt;,Traced&lt;ShapedArray(float64[2]):JaxprTrace(level=0/0)&gt;,Traced&lt;ShapedArray(float64[2]):JaxprTrace(level=0/0)&gt;
constrained fit: [ 1. 10.]
global fit: [0.         0.59398947]
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}
</div>
 

