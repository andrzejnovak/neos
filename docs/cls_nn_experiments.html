---

title: Title

keywords: fastai
sidebar: home_sidebar

summary: "summary"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: cls_nn_experiments.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
    {% raw %}
        
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pyhf</span>
<span class="kn">import</span> <span class="nn">jax</span>
<span class="kn">from</span> <span class="nn">fax.implicit</span> <span class="kn">import</span> <span class="n">twophase</span>

<span class="n">pyhf</span><span class="o">.</span><span class="n">set_backend</span><span class="p">(</span><span class="n">pyhf</span><span class="o">.</span><span class="n">tensor</span><span class="o">.</span><span class="n">jax_backend</span><span class="p">())</span>


<span class="k">class</span> <span class="nc">_Config</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poi_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">npars</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="k">def</span> <span class="nf">suggested_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">suggested_bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">]]</span>


<span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nominal</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">uncert</span> <span class="o">=</span> <span class="n">spec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">factor</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nominal</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">uncert</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aux</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">_Config</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">expected_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pars</span><span class="p">,</span> <span class="n">include_auxdata</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">mu</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">=</span> <span class="n">pars</span>
        <span class="n">expected_main</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">gamma</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nominal</span> <span class="o">+</span> <span class="n">mu</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sig</span><span class="p">])</span>
        <span class="n">aux_data</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">aux</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">expected_main</span><span class="p">,</span> <span class="n">aux_data</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">logpdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pars</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">maindata</span><span class="p">,</span> <span class="n">auxdata</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">main</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_data</span><span class="p">(</span><span class="n">pars</span><span class="p">)</span>
        <span class="n">mu</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">=</span> <span class="n">pars</span>
        <span class="n">main</span> <span class="o">=</span> <span class="n">pyhf</span><span class="o">.</span><span class="n">probability</span><span class="o">.</span><span class="n">Poisson</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">maindata</span><span class="p">)</span>
        <span class="n">constraint</span> <span class="o">=</span> <span class="n">pyhf</span><span class="o">.</span><span class="n">probability</span><span class="o">.</span><span class="n">Poisson</span><span class="p">(</span><span class="n">gamma</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor</span><span class="p">)</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">auxdata</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">main</span> <span class="o">+</span> <span class="n">constraint</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">hepdata_like</span><span class="p">(</span><span class="n">signal_data</span><span class="p">,</span> <span class="n">bkg_data</span><span class="p">,</span> <span class="n">bkg_uncerts</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Model</span><span class="p">([</span><span class="n">signal_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bkg_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bkg_uncerts</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>


<span class="c1"># Model([[signal_data[0],signal_data[1]],[bkg_data[0],bkg_data[1]],[bkg_uncerts[0],bkg_uncerts[1]]])</span>


<span class="k">def</span> <span class="nf">get_solvers</span><span class="p">(</span><span class="n">model_constructor</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">make_model</span><span class="p">(</span><span class="n">hyper_pars</span><span class="p">):</span>
        <span class="n">constrained_mu</span><span class="p">,</span> <span class="n">nn_pars</span> <span class="o">=</span> <span class="n">hyper_pars</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">hyper_pars</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">m</span><span class="p">,</span> <span class="n">bonlypars</span> <span class="o">=</span> <span class="n">model_constructor</span><span class="p">(</span><span class="n">nn_pars</span><span class="p">)</span>

        <span class="n">exp_bonly_data</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">expected_data</span><span class="p">(</span><span class="n">bonlypars</span><span class="p">,</span> <span class="n">include_auxdata</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.2</span>

        <span class="k">def</span> <span class="nf">expected_logpdf</span><span class="p">(</span><span class="n">pars</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">logpdf</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span> <span class="n">exp_bonly_data</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">global_fit_objective</span><span class="p">(</span><span class="n">pars</span><span class="p">):</span>  <span class="c1"># NLL</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">expected_logpdf</span><span class="p">(</span><span class="n">pars</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">constrained_fit_objective</span><span class="p">(</span><span class="n">nuis_par</span><span class="p">):</span>  <span class="c1"># NLL</span>
            <span class="n">pars</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                <span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">constrained_mu</span><span class="p">]),</span> <span class="n">nuis_par</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">expected_logpdf</span><span class="p">(</span><span class="n">pars</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">constrained_mu</span><span class="p">,</span> <span class="n">global_fit_objective</span><span class="p">,</span> <span class="n">constrained_fit_objective</span>

    <span class="k">def</span> <span class="nf">global_bestfit_minimized</span><span class="p">(</span><span class="n">hyper_param</span><span class="p">):</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">nll</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">make_model</span><span class="p">(</span><span class="n">hyper_param</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">bestfit_via_grad_descent</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>  <span class="c1"># gradient descent</span>
            <span class="n">param</span> <span class="o">=</span> <span class="n">param</span> <span class="o">-</span> <span class="n">jax</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">nll</span><span class="p">)(</span><span class="n">param</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.01</span>
            <span class="k">return</span> <span class="n">param</span>

        <span class="k">return</span> <span class="n">bestfit_via_grad_descent</span>

    <span class="k">def</span> <span class="nf">constrained_bestfit_minimized</span><span class="p">(</span><span class="n">hyper_param</span><span class="p">):</span>
        <span class="n">mu</span><span class="p">,</span> <span class="n">nll</span><span class="p">,</span> <span class="n">cnll</span> <span class="o">=</span> <span class="n">make_model</span><span class="p">(</span><span class="n">hyper_param</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">bestfit_via_grad_descent</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>  <span class="c1"># gradient descent</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">np</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">np</span> <span class="o">=</span> <span class="n">np</span> <span class="o">-</span> <span class="n">jax</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">cnll</span><span class="p">)(</span><span class="n">np</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.01</span>
            <span class="n">param</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">jax</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">mu</span><span class="p">]),</span> <span class="n">np</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">param</span>

        <span class="k">return</span> <span class="n">bestfit_via_grad_descent</span>

    <span class="n">global_solve</span> <span class="o">=</span> <span class="n">twophase</span><span class="o">.</span><span class="n">two_phase_solver</span><span class="p">(</span>
        <span class="n">param_func</span><span class="o">=</span><span class="n">global_bestfit_minimized</span><span class="p">,</span>
        <span class="n">default_rtol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span>
        <span class="n">default_atol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span>
        <span class="n">default_max_iter</span><span class="o">=</span><span class="mi">1000000</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">constrained_solver</span> <span class="o">=</span> <span class="n">twophase</span><span class="o">.</span><span class="n">two_phase_solver</span><span class="p">(</span>
        <span class="n">param_func</span><span class="o">=</span><span class="n">constrained_bestfit_minimized</span><span class="p">,</span>
        <span class="n">default_rtol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span>
        <span class="n">default_atol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span>
        <span class="n">default_max_iter</span><span class="o">=</span><span class="mi">1000000</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">g_fitter</span><span class="p">(</span><span class="n">init</span><span class="p">,</span> <span class="n">hyper_pars</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">global_solve</span><span class="p">(</span><span class="n">init</span><span class="p">,</span> <span class="n">hyper_pars</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

    <span class="k">def</span> <span class="nf">c_fitter</span><span class="p">(</span><span class="n">init</span><span class="p">,</span> <span class="n">hyper_pars</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">constrained_solver</span><span class="p">(</span><span class="n">init</span><span class="p">,</span> <span class="n">hyper_pars</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

    <span class="k">return</span> <span class="n">g_fitter</span><span class="p">,</span> <span class="n">c_fitter</span>


<span class="k">def</span> <span class="nf">cls_jax</span><span class="p">(</span><span class="n">hyper_pars</span><span class="p">,</span> <span class="n">test_mu</span><span class="p">,</span> <span class="n">mmaker</span><span class="p">):</span>
    <span class="n">g_fitter</span><span class="p">,</span> <span class="n">c_fitter</span> <span class="o">=</span> <span class="n">get_solvers</span><span class="p">(</span><span class="n">mmaker</span><span class="p">)</span>
    <span class="c1"># test_mu, nn_pars = hyper_pars[0], hyper_pars[1:]</span>
    <span class="n">nn_pars</span> <span class="o">=</span> <span class="n">hyper_pars</span>

    <span class="n">m</span><span class="p">,</span> <span class="n">bonlypars</span> <span class="o">=</span> <span class="n">mmaker</span><span class="p">(</span><span class="n">nn_pars</span><span class="p">)</span>
    <span class="n">exp_data</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">expected_data</span><span class="p">(</span><span class="n">bonlypars</span><span class="p">)</span>
    <span class="n">initval</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">test_mu</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>

    <span class="c1"># the constrained fit</span>
    <span class="n">numerator</span> <span class="o">=</span> <span class="n">c_fitter</span><span class="p">(</span><span class="n">initval</span><span class="p">,</span> <span class="p">[</span><span class="n">test_mu</span><span class="p">,</span> <span class="n">hyper_pars</span><span class="p">])</span>
    <span class="c1"># the global fit</span>
    <span class="n">denominator</span> <span class="o">=</span> <span class="n">g_fitter</span><span class="p">(</span><span class="n">initval</span><span class="p">,</span> <span class="p">[</span><span class="n">test_mu</span><span class="p">,</span> <span class="n">hyper_pars</span><span class="p">])</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;constrained fit: </span><span class="si">{numerator}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;global fit: </span><span class="si">{denominator}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># compute test statistic (lambda(µ))</span>
    <span class="n">profile_likelihood</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span>
        <span class="n">m</span><span class="o">.</span><span class="n">logpdf</span><span class="p">(</span><span class="n">numerator</span><span class="p">,</span> <span class="n">exp_data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">logpdf</span><span class="p">(</span><span class="n">denominator</span><span class="p">,</span> <span class="n">exp_data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="c1"># in exclusion fit zero out test stat if best fit µ^ is larger than test µ</span>
    <span class="n">muhat</span> <span class="o">=</span> <span class="n">denominator</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sqrtqmu</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">muhat</span> <span class="o">&lt;</span> <span class="n">test_mu</span><span class="p">,</span> <span class="n">profile_likelihood</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
    <span class="c1"># compute CLs</span>
    <span class="n">nullval</span> <span class="o">=</span> <span class="n">sqrtqmu</span>
    <span class="n">altval</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">CLsb</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">pyhf</span><span class="o">.</span><span class="n">tensorlib</span><span class="o">.</span><span class="n">normal_cdf</span><span class="p">(</span><span class="n">nullval</span><span class="p">)</span>
    <span class="n">CLb</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">pyhf</span><span class="o">.</span><span class="n">tensorlib</span><span class="o">.</span><span class="n">normal_cdf</span><span class="p">(</span><span class="n">altval</span><span class="p">)</span>
    <span class="n">CLs</span> <span class="o">=</span> <span class="n">CLsb</span> <span class="o">/</span> <span class="n">CLb</span>
    <span class="k">return</span> <span class="n">CLs</span>


<span class="c1"># def cls_test(hyper_pars,mmaker):</span>
<span class="c1">#    test_mu, line_pars = hyper_pars[0], hyper_pars[1:]</span>
<span class="c1">#    m,bonlypars = mmaker(line_pars)</span>
<span class="c1">#    exp_data = m.expected_data(bonlypars)</span>
<span class="c1">#    return pyhf.infer.hypotest(test_mu,exp_data,m)</span>


<span class="k">def</span> <span class="nf">get_event_data</span><span class="p">(</span><span class="n">keys</span><span class="p">):</span>
    <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">k3</span> <span class="o">=</span> <span class="n">keys</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span>
        <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="n">k1</span><span class="p">),</span>
        <span class="n">jax</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">]),</span>
        <span class="n">jax</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]),</span>
        <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5000</span><span class="p">),</span>
    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">bkg1</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span>
        <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="n">k2</span><span class="p">),</span>
        <span class="n">jax</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">]),</span>
        <span class="n">jax</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.6</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]),</span>
        <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5000</span><span class="p">),</span>
    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">bkg2</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span>
        <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="n">k3</span><span class="p">),</span>
        <span class="n">jax</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mf">5.5</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">]),</span>
        <span class="n">jax</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">([[</span><span class="mf">1.7</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]),</span>
        <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5000</span><span class="p">),</span>
    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">sig</span><span class="p">,</span> <span class="n">bkg1</span><span class="p">,</span> <span class="n">bkg2</span>


<span class="k">def</span> <span class="nf">real_model_maker</span><span class="p">(</span><span class="n">nn_params</span><span class="p">):</span>
    <span class="c1"># instantiate nn</span>
    <span class="n">nn</span> <span class="o">=</span> <span class="n">three_blob_classifier</span><span class="p">()</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">get_event_data</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="c1"># print(f&#39;nn: {nn_params}&#39;)</span>
    <span class="n">s</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">db</span> <span class="o">=</span> <span class="n">hists_from_nn_uncert</span><span class="p">(</span><span class="n">nn</span><span class="p">,</span> <span class="n">nn_params</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
    <span class="n">s</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">db</span> <span class="o">=</span> <span class="n">s</span> <span class="o">/</span> <span class="mi">10</span><span class="p">,</span> <span class="n">b</span> <span class="o">/</span> <span class="mf">10.0</span><span class="p">,</span> <span class="n">db</span> <span class="o">/</span> <span class="mf">10.0</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;model: </span><span class="si">{s}</span><span class="s2">,</span><span class="si">{b}</span><span class="s2">,</span><span class="si">{db}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">hepdata_like</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>
    <span class="n">nompars</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">suggested_init</span><span class="p">()</span>
    <span class="n">bonlypars</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">nompars</span><span class="p">])</span>
    <span class="n">bonlypars</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">index_update</span><span class="p">(</span><span class="n">bonlypars</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">poi_index</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">m</span><span class="p">,</span> <span class="n">bonlypars</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fullstream.nn</span> <span class="kn">import</span> <span class="n">three_blob_classifier</span>
<span class="kn">from</span> <span class="nn">fullstream.stats</span> <span class="kn">import</span> <span class="n">hists_from_nn_uncert</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/home/phinate/envs/fullstream/lib/python3.7/site-packages/jax-0.1.58-py3.7.egg/jax/lib/xla_bridge.py:119: UserWarning: No GPU/TPU found, falling back to CPU.
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">nn</span> <span class="o">=</span> <span class="n">three_blob_classifier</span><span class="p">()</span>

<span class="c1">### train, or random params</span>
<span class="n">nn</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">num_epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">jax</span><span class="o">.</span><span class="n">value_and_grad</span><span class="p">(</span><span class="n">cls_jax</span><span class="p">)(</span><span class="n">nn</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">real_model_maker</span><span class="p">)</span>

<span class="c1"># _, init_params = nn.init_random_params(jax.random.PRNGKey(12), (-1, 2))</span>
<span class="c1"># cls_jax(init_params,1.,real_model_maker)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>model: Traced&lt;ConcreteArray([3.20238519 6.79761481])&gt;with&lt;JVPTrace(level=2/0)&gt;,Traced&lt;ConcreteArray([43.13707402  6.86292598])&gt;with&lt;JVPTrace(level=2/0)&gt;,Traced&lt;ConcreteArray([4.44113382 4.44113382])&gt;with&lt;JVPTrace(level=2/0)&gt;
model: Traced&lt;ShapedArray(float64[2]):JaxprTrace(level=3/0)&gt;,Traced&lt;ShapedArray(float64[2]):JaxprTrace(level=3/0)&gt;,Traced&lt;ShapedArray(float64[2]):JaxprTrace(level=3/0)&gt;
model: Traced&lt;ShapedArray(float64[2]):JaxprTrace(level=3/0)&gt;,Traced&lt;ShapedArray(float64[2]):JaxprTrace(level=3/0)&gt;,Traced&lt;ShapedArray(float64[2]):JaxprTrace(level=3/0)&gt;
model: Traced&lt;ConcreteArray([3.20238519 6.79761481])&gt;with&lt;JVPTrace(level=5/0)&gt;,Traced&lt;ConcreteArray([43.13707402  6.86292598])&gt;with&lt;JVPTrace(level=5/0)&gt;,Traced&lt;ConcreteArray([4.44113382 4.44113382])&gt;with&lt;JVPTrace(level=5/0)&gt;
model: Traced&lt;ShapedArray(float64[2]):JaxprTrace(level=3/0)&gt;,Traced&lt;ShapedArray(float64[2]):JaxprTrace(level=3/0)&gt;,Traced&lt;ShapedArray(float64[2]):JaxprTrace(level=3/0)&gt;
model: Traced&lt;ShapedArray(float64[2]):JaxprTrace(level=3/0)&gt;,Traced&lt;ShapedArray(float64[2]):JaxprTrace(level=3/0)&gt;,Traced&lt;ShapedArray(float64[2]):JaxprTrace(level=3/0)&gt;
model: Traced&lt;ConcreteArray([3.20238519 6.79761481])&gt;with&lt;JVPTrace(level=5/0)&gt;,Traced&lt;ConcreteArray([43.13707402  6.86292598])&gt;with&lt;JVPTrace(level=5/0)&gt;,Traced&lt;ConcreteArray([4.44113382 4.44113382])&gt;with&lt;JVPTrace(level=5/0)&gt;
constrained fit: Traced&lt;ConcreteArray([1.         0.98072743])&gt;with&lt;JVPTrace(level=2/0)&gt;
global fit: Traced&lt;ConcreteArray([0.03389783 1.0021199 ])&gt;with&lt;JVPTrace(level=2/0)&gt;
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(DeviceArray(0.68926019, dtype=float64),
 [(DeviceArray([[ 3.2891934e-05,  7.4151361e-01, -1.3925934e-02,
                 -5.5577046e-01,  1.7432596e-01],
                [-7.0972915e-04,  1.5240345e+00, -2.8729323e-02,
                 -1.1507896e+00,  3.6045146e-01]], dtype=float32),
   DeviceArray([-1.4457165e-04,  2.9077259e-01, -5.4704603e-03,
                -2.1916847e-01,  6.8680577e-02], dtype=float32)),
  (),
  (DeviceArray([[-1.4179809e-05,  1.4179809e-05],
                [-2.8190127e-01,  2.8190127e-01],
                [-3.6950070e-02,  3.6950070e-02],
                [-6.2024558e-01,  6.2024558e-01],
                [-5.3603518e-01,  5.3603518e-01]], dtype=float32),
   DeviceArray([-0.17807451,  0.17807451], dtype=float32)),
  ()])</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}
</div>
 

